<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Docker mechanimsm</title><style>
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, YuMincho, "Yu Mincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", "Songti TC", "Songti SC", "SimSun", "Nanum Myeongjo", NanumMyeongjo, Batang, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, YuMincho, "Yu Mincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", "Songti TC", "Songti SC", "SimSun", "Nanum Myeongjo", NanumMyeongjo, Batang, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.highlight-default {
}
.highlight-gray {
	color: rgb(155,154,151);
}
.highlight-brown {
	color: rgb(100,71,58);
}
.highlight-orange {
	color: rgb(217,115,13);
}
.highlight-yellow {
	color: rgb(223,171,1);
}
.highlight-teal {
	color: rgb(15,123,108);
}
.highlight-blue {
	color: rgb(11,110,153);
}
.highlight-purple {
	color: rgb(105,64,165);
}
.highlight-pink {
	color: rgb(173,26,114);
}
.highlight-red {
	color: rgb(224,62,62);
}
.highlight-gray_background {
	background: rgb(235,236,237);
}
.highlight-brown_background {
	background: rgb(233,229,227);
}
.highlight-orange_background {
	background: rgb(250,235,221);
}
.highlight-yellow_background {
	background: rgb(251,243,219);
}
.highlight-teal_background {
	background: rgb(221,237,234);
}
.highlight-blue_background {
	background: rgb(221,235,241);
}
.highlight-purple_background {
	background: rgb(234,228,242);
}
.highlight-pink_background {
	background: rgb(244,223,235);
}
.highlight-red_background {
	background: rgb(251,228,228);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(55, 53, 47, 0.6);
	fill: rgba(55, 53, 47, 0.6);
}
.block-color-brown {
	color: rgb(100,71,58);
	fill: rgb(100,71,58);
}
.block-color-orange {
	color: rgb(217,115,13);
	fill: rgb(217,115,13);
}
.block-color-yellow {
	color: rgb(223,171,1);
	fill: rgb(223,171,1);
}
.block-color-teal {
	color: rgb(15,123,108);
	fill: rgb(15,123,108);
}
.block-color-blue {
	color: rgb(11,110,153);
	fill: rgb(11,110,153);
}
.block-color-purple {
	color: rgb(105,64,165);
	fill: rgb(105,64,165);
}
.block-color-pink {
	color: rgb(173,26,114);
	fill: rgb(173,26,114);
}
.block-color-red {
	color: rgb(224,62,62);
	fill: rgb(224,62,62);
}
.block-color-gray_background {
	background: rgb(235,236,237);
}
.block-color-brown_background {
	background: rgb(233,229,227);
}
.block-color-orange_background {
	background: rgb(250,235,221);
}
.block-color-yellow_background {
	background: rgb(251,243,219);
}
.block-color-teal_background {
	background: rgb(221,237,234);
}
.block-color-blue_background {
	background: rgb(221,235,241);
}
.block-color-purple_background {
	background: rgb(234,228,242);
}
.block-color-pink_background {
	background: rgb(244,223,235);
}
.block-color-red_background {
	background: rgb(251,228,228);
}
.select-value-color-default { background-color: rgba(206,205,202,0.5); }
.select-value-color-gray { background-color: rgba(155,154,151, 0.4); }
.select-value-color-brown { background-color: rgba(140,46,0,0.2); }
.select-value-color-orange { background-color: rgba(245,93,0,0.2); }
.select-value-color-yellow { background-color: rgba(233,168,0,0.2); }
.select-value-color-green { background-color: rgba(0,135,107,0.2); }
.select-value-color-blue { background-color: rgba(0,120,223,0.2); }
.select-value-color-purple { background-color: rgba(103,36,222,0.2); }
.select-value-color-pink { background-color: rgba(221,0,129,0.2); }
.select-value-color-red { background-color: rgba(255,0,26,0.2); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="453d2eec-e945-4da5-b9f0-f6d2683246db" class="page sans"><header><img class="page-cover-image" src="https://www.notion.so/images/page-cover/met_vincent_van_gogh_cradle.jpg" style="object-position:center 80%"/><div class="page-header-icon page-header-icon-with-cover"><span class="icon">ğŸ¥¶</span></div><h1 class="page-title">Docker mechanimsm</h1></header><div class="page-body"><p id="30df53f6-05e9-4bbc-93ec-bed551e0bf4f" class="">å®¹å™¨çš„æœ¬è´¨æ˜¯ä¸€ä¸ªè¿›ç¨‹</p><p id="5cd7ecd9-4986-4c34-8a5e-68cc1ab51ef4" class="">å®¹å™¨çš„å¯åŠ¨è¿›ç¨‹å°±æ˜¯å®¹å™¨é‡ŒPID=1çš„è¿›ç¨‹</p><ul id="d2c011ca-1977-41c1-bb4c-21cf27284a79" class="bulleted-list"><li>ä¸€ä¸ªå®¹å™¨ä¸èƒ½è·‘ä¸¤ä¸ªåº”ç”¨, å› æ­¤å¸¸å¸¸ç”¨systemdæˆ–è€…supervisordæ¥ä»£æ›¿åº”ç”¨æˆä¸ºå®¹å™¨çš„å¯åŠ¨è¿›ç¨‹</li></ul><p id="a1395554-3af4-40f6-a5d3-af8b6bc5d342" class="">
</p><h3 id="f2ba7c5d-61f8-4a26-8893-e78f36bf6ff9" class="">å®¹å™¨çš„â€œéš”ç¦»â€ä¸â€œé™åˆ¶â€</h3><p id="5ee0100e-a92b-4525-a7a7-0ab63765e925" class="">ç›¸å¯¹äºè™šæ‹Ÿæœºæ¥è¯´ï¼Œå®¹å™¨æ²¡æœ‰ä¸“é—¨çš„cpuã€å†…å­˜ç­‰ï¼Œæ²¡æœ‰è™šæ‹Ÿçš„æ“ä½œç³»ç»Ÿï¼Œåªæ˜¯é€šè¿‡namespaceé‡å‘½åçš„è¿›ç¨‹è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼Œæ²¡æœ‰å®è´¨æ€§çš„éš”ç¦»ï¼Œä¼šå‘ç”Ÿå®¹å™¨å†…çš„åº”ç”¨è¶Šç‹±ç­‰æƒ…å†µã€‚ä½†å¯ä»¥é€šè¿‡cgroupæ¥é™åˆ¶å®¹å™¨çš„cpuå†…å­˜ç­‰çš„ä½¿ç”¨ï¼Œç°æœ‰é—®é¢˜æ˜¯topï¼Œ/procä¸‹æŸ¥çœ‹åˆ°çš„è¿˜æ˜¯ç‰©ç†æœºçš„ç›¸å…³ä¿¡æ¯ã€‚</p><ul id="5b13eedf-e607-4306-9f2c-f28e45eb2231" class="toggle"><li><details open=""><summary>namespace</summary><p id="f4796501-5955-4537-b4a3-778e86e77ad7" class="">Linux æ“ä½œç³»ç»Ÿæä¾›äº†PID Namespaceï¼ŒMountã€UTSã€IPCã€Network å’Œ User Namespaceï¼Œç”¨æ¥å¯¹å„ç§ä¸åŒçš„è¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œâ€œéšœçœ¼æ³•â€æ“ä½œã€‚æ¯”å¦‚ï¼ŒMount Namespaceï¼Œç”¨äºè®©è¢«éš”ç¦»è¿›ç¨‹åªçœ‹åˆ°å½“å‰ Namespace é‡Œçš„æŒ‚è½½ç‚¹ä¿¡æ¯ï¼›Network Namespaceï¼Œç”¨äºè®©è¢«éš”ç¦»è¿›ç¨‹çœ‹åˆ°å½“å‰ Namespace é‡Œçš„ç½‘ç»œè®¾å¤‡å’Œé…ç½®ã€‚</p><p id="fe97dd59-1ef6-4aa9-87cc-a17119172c46" class="">
</p><p id="5e4a7c89-ce3a-428e-8f34-724b683969a0" class=""><strong>int pid = clone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, NULL);</strong></p><p id="8b785911-26e7-466e-819e-85536198a91d" class="">Linuxç³»ç»Ÿè°ƒç”¨clone()åˆ›å»ºä¸€ä¸ªè¿›ç¨‹(çº¿ç¨‹), <mark class="highlight-yellow">å‚æ•°</mark><mark class="highlight-yellow"><strong>CLONE_NEWPID, </strong></mark><mark class="highlight-yellow">ä½¿å¾—æ–°å»ºè¿›ç¨‹åªèƒ½â€œçœ‹åˆ°ä¸€ä¸ªå…¨æ–°çš„ç©ºé—´â€, pidä»1å¼€å§‹. ä½†è¯¥è¿›ç¨‹åœ¨å®¿ä¸»æœºé‡Œçš„è¿›ç¨‹ä»ä¸ºçœŸå®æ•°å€¼, æ¯”å¦‚100</mark></p><p id="dfe7361e-cda9-4501-bb53-4ac28019b02c" class="">
</p><p id="08e39eb2-f8f7-4d92-b1d2-fcf7de96b547" class="">åœ¨ç†è§£äº† Namespace çš„å·¥ä½œæ–¹å¼ä¹‹åï¼Œä½ å°±ä¼šæ˜ç™½ï¼Œè·ŸçœŸå®å­˜åœ¨çš„è™šæ‹Ÿæœºä¸åŒï¼Œåœ¨ä½¿ç”¨ Docker çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªçœŸæ­£çš„â€œDocker å®¹å™¨â€è¿è¡Œåœ¨å®¿ä¸»æœºé‡Œé¢ã€‚Docker é¡¹ç›®å¸®åŠ©ç”¨æˆ·å¯åŠ¨çš„ï¼Œè¿˜æ˜¯åŸæ¥çš„åº”ç”¨è¿›ç¨‹ï¼Œåªä¸è¿‡åœ¨åˆ›å»ºè¿™äº›è¿›ç¨‹æ—¶ï¼ŒDocker ä¸ºå®ƒä»¬åŠ ä¸Šäº†å„ç§å„æ ·çš„ Namespace å‚æ•°ã€‚è¿™æ—¶ï¼Œè¿™äº›è¿›ç¨‹å°±ä¼šè§‰å¾—è‡ªå·±æ˜¯å„è‡ª PID Namespace é‡Œçš„ç¬¬ 1 å·è¿›ç¨‹ï¼Œåªèƒ½çœ‹åˆ°å„è‡ª Mount Namespace é‡ŒæŒ‚è½½çš„ç›®å½•å’Œæ–‡ä»¶ï¼Œåªèƒ½è®¿é—®åˆ°å„è‡ª Network Namespace é‡Œçš„ç½‘ç»œè®¾å¤‡ï¼Œå°±ä»¿ä½›è¿è¡Œåœ¨ä¸€ä¸ªä¸ªâ€œå®¹å™¨â€é‡Œé¢ï¼Œä¸ä¸–éš”ç»ã€‚</p><p id="42a4e53b-366a-4452-a232-218084e70349" class="">
</p><figure class="block-color-yellow callout" style="white-space:pre-wrap;display:flex" id="bd4db816-f335-4282-8575-7924302a42da"><div style="font-size:1.5em"><span class="icon">ğŸ“Œ</span></div><div style="width:100%">ç¼ºç‚¹: éš”ç¦»ä¸å½»åº•</div></figure><ul id="ba8f4235-032a-4158-80c2-1295c22fc393" class="bulleted-list"><li>æ—¢ç„¶å®¹å™¨åªæ˜¯è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šçš„ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆå¤šä¸ªå®¹å™¨ä¹‹é—´ä½¿ç”¨çš„å°±è¿˜æ˜¯åŒä¸€ä¸ªå®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚<mark class="highlight-yellow">å…±äº«å®¿ä¸»æœºå†…æ ¸</mark></li></ul><ul id="baa8b752-6b7d-45d8-b733-57a395362bf7" class="bulleted-list"><li>å¾ˆå¤šèµ„æºå’Œå¯¹è±¡æ— æ³•è¢«namespaceåŒ–, æ¯”å¦‚æ—¶é—´, å¦‚æœå®¹å™¨ä¸­çš„ç¨‹åºä½¿ç”¨ settimeofday(2) ç³»ç»Ÿè°ƒç”¨ä¿®æ”¹äº†æ—¶é—´ï¼Œæ•´ä¸ªå®¿ä¸»æœºçš„æ—¶é—´éƒ½ä¼šè¢«éšä¹‹ä¿®æ”¹ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆç”¨æˆ·çš„é¢„æœŸã€‚</li></ul><p id="58f69e02-5d18-41ba-8543-5c374b5e0c51" class="">
</p></details></li></ul><ul id="b4494bc5-c4f4-48ff-82e9-db2150825797" class="toggle"><li><details open=""><summary>cgroups: </summary><p id="4c620010-a4fd-4722-844a-0d4e339728dc" class="">Linux Cgroups æ˜¯ Linux å†…æ ¸ä¸­ç”¨æ¥è®¾ç½®ä¸€ä¸ªè¿›ç¨‹ç»„èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºä¸Šé™ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå¸¦å®½ç­‰ç­‰ã€‚</p><p id="4beaedf2-5791-4718-a4cf-9e2cdd6c262b" class="">
</p><p id="7efa0339-382a-422d-8d14-419f015a7f59" class="">åœ¨ /sys/fs/cgroup ä¸‹é¢æœ‰å¾ˆå¤šè¯¸å¦‚ cpusetã€cpuã€ memory è¿™æ ·çš„å­ç›®å½•ï¼Œä¹Ÿå«å­ç³»ç»Ÿã€‚è¿™äº›éƒ½æ˜¯è¿™å°æœºå™¨å½“å‰å¯ä»¥è¢« Cgroups è¿›è¡Œé™åˆ¶çš„èµ„æºç§ç±»</p><pre id="d71859d7-c568-4bc4-99d1-dc1f242e6b3a" class="code"><code>$ mount -t cgroup 
cpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
cpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)
cpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)
blkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
memory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
...</code></pre><p id="c437a5bc-fcbd-4849-88ce-9ef493b38e04" class="">
</p><p id="c4f7d757-78e2-43b9-a6ee-f03539f6a9b0" class="">åœ¨cpuå­ç³»ç»Ÿä¸‹åˆ›å»ºç›®å½•container, è¿™ä¸ªç›®å½•å°±ç§°ä¸ºä¸€ä¸ªâ€œæ§åˆ¶ç»„â€</p><p id="4e7e3d26-bc59-4bb6-89f9-09415f55e785" class="">æŠŠè¢«é™åˆ¶çš„è¿›ç¨‹çš„ PID å†™å…¥ container ç»„é‡Œçš„ tasks æ–‡ä»¶ï¼Œé™åˆ¶å°±ä¼šå¯¹è¯¥è¿›ç¨‹ç”Ÿæ•ˆäº†</p><pre id="572389dd-708a-4c70-8f4a-78b5d1777783" class="code"><code>root@ubuntu:/sys/fs/cgroup/cpu$ mkdir container
root@ubuntu:/sys/fs/cgroup/cpu$ ls container/
cgroup.clone_children cpu.cfs_period_us cpu.rt_period_us  cpu.shares notify_on_release
cgroup.procs      cpu.cfs_quota_us  cpu.rt_runtime_us cpu.stat  tasks</code></pre><p id="75afee8d-a6be-4638-bb53-cff2703afe33" class="">
</p><p id="0c5bbc76-346c-4d2d-8ca8-cc36ecef0479" class="">docker runä¸€ä¸ªå®¹å™¨çš„æ—¶å€™åšäº†å“ªäº›äº‹æƒ…?<div class="indented"><ol id="3cbafa56-2a58-46aa-9d7f-e30c06e0102e" class="numbered-list" start="1"><li>åœ¨æ¯ä¸ªå­ç³»ç»Ÿä¸‹ä¸ºæ¯ä¸€ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„, åœ¨å¯åŠ¨å®¹å™¨è¿›ç¨‹ä¹‹åï¼ŒæŠŠè¿™ä¸ªè¿›ç¨‹çš„ PID å¡«å†™åˆ°å¯¹åº”æ§åˆ¶ç»„çš„ tasks æ–‡ä»¶ä¸­å°±å¯ä»¥äº†</li></ol><p id="d56f51a8-9b0e-4761-b818-4eeff097f58f" class="">
</p></div></p><p id="f89e3d99-fd37-46d4-94ce-22e8310c9bf9" class="">issue:</p><ol id="e40ce5b4-8ac7-4cf8-bd2e-c9e5b2b590ee" class="numbered-list" start="1"><li>åœ¨å®¹å™¨é‡Œä½¿ç”¨topå‘½ä»¤, èƒ½çœ‹åˆ°å®¿ä¸»æœºçš„cpuå’Œå†…å­˜æ•°æ®, è€Œä¸æ˜¯å½“å‰å®¹å™¨çš„æ•°æ®<p id="97f5a58d-5eae-40e1-aa0c-0df7a00f9d7b" class="">Linux ä¸‹çš„ /proc ç›®å½•å­˜å‚¨çš„æ˜¯è®°å½•å½“å‰å†…æ ¸è¿è¡ŒçŠ¶æ€çš„ä¸€ç³»åˆ—ç‰¹æ®Šæ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è®¿é—®è¿™äº›æ–‡ä»¶ï¼ŒæŸ¥çœ‹ç³»ç»Ÿä»¥åŠå½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ CPU ä½¿ç”¨æƒ…å†µã€å†…å­˜å ç”¨ç‡ç­‰ï¼Œè¿™äº›æ–‡ä»¶ä¹Ÿæ˜¯ top æŒ‡ä»¤æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯çš„ä¸»è¦æ•°æ®æ¥æºã€‚/proc æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸çŸ¥é“ç”¨æˆ·é€šè¿‡ Cgroups ç»™è¿™ä¸ªå®¹å™¨åšäº†ä»€ä¹ˆæ ·çš„èµ„æºé™åˆ¶ï¼Œå³ï¼š/proc æ–‡ä»¶ç³»ç»Ÿä¸äº†è§£ Cgroups é™åˆ¶çš„å­˜åœ¨ã€‚</p><p id="d312ed18-5406-4961-a6bc-e39dc8a84174" class=""><mark class="highlight-yellow">solution:  </mark></p><p id="6f8e8136-825e-442d-bf7d-ff01670185f6" class="">top æ˜¯ä» /prof/stats ç›®å½•ä¸‹è·å–æ•°æ®ï¼Œæ‰€ä»¥é“ç†ä¸Šæ¥è®²ï¼Œå®¹å™¨ä¸æŒ‚è½½å®¿ä¸»æœºçš„è¯¥ç›®å½•å°±å¯ä»¥äº†ã€‚lxcfså°±æ˜¯æ¥å®ç°è¿™ä¸ªåŠŸèƒ½çš„ï¼Œåšæ³•æ˜¯æŠŠå®¿ä¸»æœºçš„ /var/lib/lxcfs/proc/memoinfo æ–‡ä»¶æŒ‚è½½åˆ°Dockerå®¹å™¨çš„/proc/meminfoä½ç½®åã€‚å®¹å™¨ä¸­è¿›ç¨‹è¯»å–ç›¸åº”æ–‡ä»¶å†…å®¹æ—¶ï¼ŒLXCFSçš„FUSEå®ç°ä¼šä»å®¹å™¨å¯¹åº”çš„Cgroupä¸­è¯»å–æ­£ç¡®çš„å†…å­˜é™åˆ¶ã€‚ä»è€Œä½¿å¾—åº”ç”¨è·å¾—æ­£ç¡®çš„èµ„æºçº¦æŸè®¾å®šã€‚kubernetesç¯å¢ƒä¸‹ï¼Œä¹Ÿèƒ½ç”¨ï¼Œä»¥ds æ–¹å¼è¿è¡Œ lxcfs ï¼Œè‡ªåŠ¨ç»™å®¹å™¨æ³¨å…¥äº‰å–çš„ proc ä¿¡æ¯ã€‚</p><p id="12a7289d-1c38-4bd4-ba28-02a4e910bbcb" class="">æ›´å…·ä½“çš„è§</p><figure id="dffdb260-c93a-4783-bd9f-dff90df8d705"><a href="https://www.jianshu.com/p/2db635b9836c" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">lxcfså®¹å™¨éš”ç¦»æŠ€æœ¯å®ç°åŸç†åˆ†æä¹‹loadavgã€cpuonline</div><div class="bookmark-description">lxcfsæ˜¯ä»€ä¹ˆ æˆ‘ä»¬çŸ¥é“runcæ²¡æœ‰åšåˆ°å®Œå…¨éš”ç¦»/procã€/sysè·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å®¹å™¨å†…é€šè¿‡topã€freeç­‰å‘½ä»¤çœ‹åˆ°çš„æ•°æ®éƒ½æ˜¯ç‰©ç†æœºä¸Šçš„ã€‚å¯¹äºä¹ æƒ¯äº†è™šæœºï¼Œç‰©ç†æœºçš„åŒå­¦...</div></div><div class="bookmark-href"><img src="data:image/vnd.microsoft.icon;base64,AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAABILAAASCwAAAAAAAAAAAAAAAAAASWTtHEhh5qZIYObmSGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDm5khh5qZJZO0cAAAAAElk7RxIYeXtSGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hh5e1JZO0cSGHmpkhg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hh5qZIYObmSGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDm5khg5f9IYOX/SGDl/0hg5f9IYOX/ipnu/5qn8P9qfen/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/TWTl/5qn8P+grfH/nKnx/3iJ6/9JYeX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f/Cyvb///////T2/f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f99juz//////////////////////8vS9/9LY+X/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/8LK9v///////f3+/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/2l96f+hrfH/o6/x/9HX+P///////////5Gg7/9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/wsr2///////9/f7/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/Vmzn////////////usP1/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f/Cyvb///////39/v9IYOX/SGDl/46d7v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7/8fP9/8LK9v9keOn/SGDl/0hg5f9JYeX///////////+9xvX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/8LK9v///////f3+/0hg5f9IYOX/j53v////////////ydD3/6ax8v+msfL/prHy/6248//t8Pz//////+/x/P9dcuj/SGDl/0lh5f///////////73G9f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/wsr2///////9/f7/SGDl/0hg5f+Pne////////////+RoO//SGDl/0hg5f9IYOX/SGDl/5Kg7////////////56q8f9IYOX/SWHl////////////vcb1/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f/Cyvb///////39/v9IYOX/SGDl/4+d7////////////5Oh7/9JYeX/SWHl/0lh5f9JYeX/h5fu////////////ucL1/0hg5f9JYeX///////////+9xvX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/8LK9v///////f3+/0hg5f9IYOX/j53v//////////////////////////////////////////////////////+4wfX/SGDl/0lh5f///////////73G9f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/wsr2///////9/f7/SGDl/0hg5f+Pne/////////////g5Pr/xs32/8bN9v/Gzfb/xs32/9jd+f///////////7fB9P9IYOX/SWHl////////////vcb1/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f/Cyvb///////39/v9IYOX/SGDl/4+d7////////////5uo8P9IYOX/SGDl/0hg5f9IYOX/gZHt////////////t8D0/0hg5f9JYeX///////////+9xvX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/8LK9v///////f3+/0hg5f9IYOX/j53v////////////m6jw/0hg5f9IYOX/SGDl/0hg5f+Bke3///////////+2wPT/SGDl/0lh5f///////////73G9f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/wsr2///////9/f7/SGDl/0hg5f+Pne///////////////////////////////////////////////////////7W/9P9IYOX/SWHl////////////vcb1/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f/Cyvb///////39/v9IYOX/SGDl/4WV7f/l6Pv/5ej7/+Xo+//l6Pv/5ej7/+Xo+//l6Pv/5ej7/+Xo+//l6Pv/pbHy/0hg5f9JYeX///////////+9xvX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/2h86f96i+z/eozs/7S+9P/K0ff/p7Ly/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0lh5f///////////73G9f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9gdej///////////+8xfX/bYDq/5il8P+YpfD/mKXw/5il8P+YpfD/mKXw/5il8P+YpfD/mKXw/5il8P+YpfD/mafw////////////vcb1/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/7zF9f//////9fb9/1906P/P1fj///////////////////////////////////////////////////////////////////////////+9xvX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/oK3x/1Rq5v9/kOz///////z9/v99juz/SGDl/6u28//AyPb/wMj2/8DI9v/K0ff/4eX6/8DI9v/AyPb/wMj2/8DI9v/AyPb/wMj2/8DI9v/AyPb/wMj2/5Wj8P9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f/8/f7/9fb9/6248/9Uaub/TWTl/0hg5f9/kOz/6Ov7/+Hl+v9ccuf/SGDl/3WH6///////vMX1/1Fo5v9IYOX/SGDl/0hg5f/L0vf/9/j9/8TL9v9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/6Ov8f/6+/7//////87U+P9PZub/SGDl/7rD9f//////9fb9/05l5f9IYOX/YXXo/+7w/P//////3eL6/1lu5/9IYOX/TWTl//f4/f//////rbjz/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/22A6v/09v3//////9fc+f+Zp/D/9vf9///////Y3fn/j53v/5Si7/+Wo/D/Znrp/93i+v//////3uL6/5mn8P+yvPT///////////+yvPT/mafw/5mn8P96i+z/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/32O7P////////////////////////////////////////////////+cqfH/X3To//r7/v////////////////////////////////////////////Hz/f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/8zT9////////////2l86f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/usP1////////////iJju/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/jJvu////////////kZ/v/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9/kOz///////////+eqvH/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5uZIYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9KYeX/SmHl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYObmSGHmpkhg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hh5qZJZO0cSGHl7Uhg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYeXtSWTtHAAAAABJZO0cSGHmpkhg5uZIYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYOX/SGDl/0hg5f9IYObmSGHmpklk7RwAAAAAgAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAE=" class="icon bookmark-icon"/>https://www.jianshu.com/p/2db635b9836c</div></div><img src="https://upload-images.jianshu.io/upload_images/14774548-417f332fcb4cee01.png" class="bookmark-image"/></a></figure></li></ol></details></li></ul><p id="bebbd8e3-cd1e-49d6-8d8c-4f74fecb1389" class="">
</p><h3 id="9416ac48-35cc-4b83-a8bf-3c973c54df52" class="">é•œåƒæ˜¯ä»€ä¹ˆ? (imageæ˜¯dockerå´›èµ·çš„å…³é”®åˆ›æ–°)</h3><ul id="9d494dd9-0cdc-4681-b5ba-f668067dba1f" class="toggle"><li><details open=""><summary>è¿™ä¸ªæŒ‚è½½åœ¨å®¹å™¨æ ¹ç›®å½•ä¸Šã€ç”¨æ¥ä¸ºå®¹å™¨è¿›ç¨‹æä¾›éš”ç¦»åæ‰§è¡Œç¯å¢ƒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯æ‰€è°“çš„â€œå®¹å™¨é•œåƒâ€.  é•œåƒå³rootfs, ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ‰€åŒ…å«çš„æ–‡ä»¶ã€é…ç½®å’Œç›®å½•, ä½†æ˜¯ä¸åŒ…æ‹¬ç³»ç»Ÿå†…æ ¸. </summary><p id="d55852e3-a30e-44d0-9f99-65b4e9cfc73e" class="">
</p><p id="51dd1064-dac5-44bb-a079-cc3da2700428" class="">æ–°åˆ›å»ºçš„å®¹å™¨ä¼šç›´æ¥ç»§æ‰¿å®¿ä¸»æœºçš„å„ä¸ªæŒ‚è½½ç‚¹</p><figure class="block-color-yellow callout" style="white-space:pre-wrap;display:flex" id="a5844324-c824-4795-9176-3f711cfe49d5"><div style="font-size:1.5em"><span class="icon">ğŸ“Œ</span></div><div style="width:100%">å³ä¾¿å¼€å¯äº†mount namespace, å®¹å™¨è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿä»ç„¶ä¸å®¿ä¸»æœºå®Œå…¨ä¸€æ ·</div></figure><p id="22290367-6235-4dd5-9a8a-bd65032a6be6" class="">Mount Namespace è·Ÿå…¶ä»– Namespace çš„ä½¿ç”¨ç•¥æœ‰ä¸åŒçš„åœ°æ–¹ï¼šå®ƒå¯¹å®¹å™¨è¿›ç¨‹è§†å›¾çš„æ”¹å˜ï¼Œä¸€å®šæ˜¯ä¼´éšç€æŒ‚è½½æ“ä½œï¼ˆmountï¼‰æ‰èƒ½ç”Ÿæ•ˆ</p><p id="d2f02036-d9f9-42fa-bc10-db3f46f8436c" class="">
</p><p id="0b27de7e-e94b-453d-a7f8-1a9b6e83a80f" class=""><mark class="highlight-yellow">åœ¨å®¹å™¨è¿›ç¨‹å¯åŠ¨ä¹‹å‰, ä½¿ç”¨chrootå‘½ä»¤, æŠŠå®¹å™¨è¿›ç¨‹çš„æ ¹ç›®å½•ä¿®æ”¹ä¸ºæŸä¸€ç›®å½•(ä¹Ÿå°±æ˜¯é‡æ–°æŒ‚è½½å®¹å™¨è¿›ç¨‹çš„æ•´ä¸ªæ ¹ç›®å½•)</mark></p><p id="b7912b0e-773d-44a6-a5fe-65c157f1b77e" class="">
</p><p id="2eb900f1-ebad-475c-a59a-1cf0742eaa63" class="">å°†æ•´ä¸ªubuntuçš„æ–‡ä»¶ç³»ç»Ÿæ‹·è´åˆ°$HOME/testç›®å½•, </p><p id="cb5a4d4b-9856-4bf9-9515-7a80ccd44f37" class="">æ‰§è¡Œchroot, å‘Šè¯‰æ“ä½œç³»ç»Ÿ, æˆ‘ä»¬å°†ä½¿ç”¨$HOME/testç›®å½•ä½œä¸º/bin/bashè¿›ç¨‹çš„æ ¹ç›®å½•</p><pre id="1b8ea095-afe5-44a6-a9f6-3101b6d6c76a" class="code"><code>chroot $HOME/test /bin/bash</code></pre><p id="20a0aef1-4e9b-4024-87f6-616ae586fec2" class="">
</p><p id="9ce6ae78-cb28-49c1-b98f-1f1b5b01682f" class="block-color-yellow">è¿™ä¸ªæŒ‚è½½åœ¨å®¹å™¨æ ¹ç›®å½•ä¸Šã€ç”¨æ¥ä¸ºå®¹å™¨è¿›ç¨‹æä¾›éš”ç¦»åæ‰§è¡Œç¯å¢ƒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯æ‰€è°“çš„â€œå®¹å™¨é•œåƒâ€.  é•œåƒå³rootfs, ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ‰€åŒ…å«çš„æ–‡ä»¶ã€é…ç½®å’Œç›®å½•, ä½†æ˜¯ä¸åŒ…æ‹¬ç³»ç»Ÿå†…æ ¸. </p><ul id="1e2b3932-8d23-4571-b469-72ac9a2480cc" class="bulleted-list"><li>ä¸€å°æœºå™¨ä¸Šçš„æ‰€æœ‰å®¹å™¨å…±äº«å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸, æ‰€ä»¥å°‘æ•°ä¾èµ–å†…æ ¸çš„åº”ç”¨æ˜¯ä¸èƒ½è·¨å¹³å°çš„(å¤šæ•°åº”ç”¨æ²¡æœ‰å†…æ ¸ä¾èµ–)</li></ul><figure class="block-color-yellow callout" style="white-space:pre-wrap;display:flex" id="28eb03e0-95c1-4c81-a0a4-b0d466ef032f"><div style="font-size:1.5em"><span class="icon">ğŸ“Œ</span></div><div style="width:100%">ç”±äº rootfs é‡Œæ‰“åŒ…çš„ä¸åªæ˜¯åº”ç”¨ï¼Œè€Œæ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å’Œç›®å½•ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œåº”ç”¨ä»¥åŠå®ƒè¿è¡Œæ‰€éœ€è¦çš„æ‰€æœ‰ä¾èµ–ï¼Œéƒ½è¢«å°è£…åœ¨äº†ä¸€èµ·ã€‚</div></figure><p id="cda4b130-dbd0-4495-b266-893c765b407f" class="">
</p><hr id="1b7fb497-382f-4ef9-ba8e-11f99b87c8c4"/><p id="9837a0a9-ad6b-4e84-9fd8-2385b891f7e7" class="">
</p><h3 id="0258e313-53bc-4fb9-a933-d2dc826234e2" class="">Dockeråˆ›æ–°äº†å¢é‡åˆ†å±‚çš„rootfs</h3><blockquote id="017e693b-f67a-4b4a-9457-78b7b6f96e93" class="">Docker åœ¨é•œåƒçš„è®¾è®¡ä¸­ï¼Œå¼•å…¥äº†å±‚ï¼ˆlayerï¼‰çš„æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·åˆ¶ä½œé•œåƒçš„æ¯ä¸€æ­¥æ“ä½œï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå±‚ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¢é‡ rootfsã€‚</blockquote><p id="dcbf2172-6c8e-4bc7-9707-1ac26a8df07b" class="">Union File System, ä¹Ÿå« UnionFSï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯å°†å¤šä¸ªä¸åŒä½ç½®çš„ç›®å½•è”åˆæŒ‚è½½ï¼ˆunion mountï¼‰åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚</p><p id="b1352eb7-b769-4298-9a1c-5b744dda3035" class="">
</p><p id="b7b504fb-4cfb-4461-8af6-17c892bb5ad3" class="">æ¯”å¦‚</p><pre id="24df0f72-6203-48b4-aff5-f8829c46ad19" class="code"><code>$ docker image inspect ubuntu:latest
...
     &quot;RootFS&quot;: {
      &quot;Type&quot;: &quot;layers&quot;,
      &quot;Layers&quot;: [
        &quot;sha256:f49017d4d5ce9c0f544c...&quot;,
        &quot;sha256:8f2b771487e9d6354080...&quot;,
        &quot;sha256:ccd4d61916aaa2159429...&quot;,
        &quot;sha256:c01d74f99de40e097c73...&quot;,
        &quot;sha256:268a067217b5fe78e000...&quot;
      ]
    }</code></pre><p id="443f116f-2883-4476-89f5-b5a4a0547994" class="">è¿™ä¸ªubuntué•œåƒç”±5ä¸ªå±‚ç»„æˆ, å³5ä¸ªå¢é‡rootfs.</p><p id="227e7626-a045-4d2b-b7ca-05d779db191c" class="">æ¯ä¸€å±‚éƒ½æ˜¯ Ubuntu æ“ä½œç³»ç»Ÿæ–‡ä»¶ä¸ç›®å½•çš„ä¸€éƒ¨åˆ†ï¼›è€Œåœ¨ä½¿ç”¨é•œåƒæ—¶ï¼ŒDocker ä¼šæŠŠè¿™äº›å¢é‡è”åˆæŒ‚è½½åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æŒ‚è½½ç‚¹ä¸Š</p><ul id="25a442a9-950e-47ba-b33a-7d781fe38156" class="toggle"><li><details open=""><summary>è‡ªå·±åœ¨è™šæ‹Ÿæœºä¸Šçš„å®éªŒ</summary><p id="9a92b97f-818c-4484-a8e3-e216e8927545" class="">ç›®å½•ç»“æ„ä¸2018å¹´çš„æ•™ç¨‹ç›¸æ¯”å·²ç»æœ‰å¾ˆå¤§å˜åŒ–äº†</p><p id="aedf372f-3faf-4db6-94fe-100f8cff22e9" class="">/var/lib/docker/containers è®°å½•æ‰€æœ‰å®¹å™¨</p><figure id="3ba02a86-12ac-4ddc-a9d7-893d65f12f89" class="image"><a href="Docker%20mechanimsm%20453d2eece9454da5b9f0f6d2683246db/Screen_Shot_2020-07-15_at_11.36.51_PM.png"><img style="width:1854px" src="Docker%20mechanimsm%20453d2eece9454da5b9f0f6d2683246db/Screen_Shot_2020-07-15_at_11.36.51_PM.png"/></a></figure><p id="3fea1035-8dc0-4bbf-9e00-49854533a34f" class="">/var/lib/docker/overlay2 è®°å½•æ‰€æœ‰layers</p><p id="cc701d7d-c5d4-4c7c-98da-7615615a4ac1" class="">var/lib/docker/overlay2/6ea.........b087/diff ä¸‹é¢æ˜¯ubuntuæ–‡ä»¶ç³»ç»Ÿçš„runæ–‡ä»¶</p><p id="6d93cc38-9d9a-4035-9ffe-8bf488fdc429" class="">
</p><p id="02492627-71eb-42ea-bd9b-3a18c7e24dcb" class="">var/lib/docker/overlay2/</p><p id="207582f6-9c09-43c1-b94b-85de71f987a1" class="">
</p><figure id="65699dba-97c0-467e-949f-d42dcf275158" class="image"><a href="Docker%20mechanimsm%20453d2eece9454da5b9f0f6d2683246db/Screen_Shot_2020-07-15_at_11.48.04_PM.png"><img style="width:1844px" src="Docker%20mechanimsm%20453d2eece9454da5b9f0f6d2683246db/Screen_Shot_2020-07-15_at_11.48.04_PM.png"/></a></figure></details></li></ul><p id="624fe847-9db2-4af0-96c1-0ee6cc418886" class="">
</p><figure id="d29af57c-56ea-4231-8368-c6d553d05e3d" class="image"><a href="Docker%20mechanimsm%20453d2eece9454da5b9f0f6d2683246db/Screen_Shot_2020-07-13_at_5.52.45_PM.png"><img style="width:1136px" src="Docker%20mechanimsm%20453d2eece9454da5b9f0f6d2683246db/Screen_Shot_2020-07-13_at_5.52.45_PM.png"/></a></figure><p id="f23cd69b-7f0d-4c44-a60b-2b41246ee240" class="">
</p><ul id="0036b13b-36ff-4b06-9220-e13dd60999ef" class="bulleted-list"><li>åªè¯»å±‚<p id="50346c00-82a5-46f0-ba76-49cb0e0016f0" class="">å®ƒä»¬çš„æŒ‚è½½æ–¹å¼éƒ½æ˜¯åªè¯»çš„ï¼ˆro+whï¼Œå³ readonly+whiteout)</p><p id="f567f07b-eb4b-4523-80f3-7e7cab9df64d" class="">whiteoutæ–‡ä»¶å°†è¢«â€œåˆ é™¤â€çš„æ–‡ä»¶é®æŒ¡èµ·æ¥</p></li></ul><ul id="d14895ed-57e9-4e01-a2ff-8b9148daa823" class="bulleted-list"><li>å¯è¯»å†™å±‚<p id="e9bdab16-1fc0-45f6-8631-ca26c24580fe" class="">åœ¨æ²¡æœ‰å†™å…¥æ–‡ä»¶ä¹‹å‰, è¿™ä¸ªç›®å½•æ˜¯ç©ºçš„. ä¸€æ—¦åœ¨å®¹å™¨é‡Œåšäº†å†™æ“ä½œï¼Œä½ ä¿®æ”¹äº§ç”Ÿçš„å†…å®¹å°±ä¼šä»¥å¢é‡çš„æ–¹å¼å‡ºç°åœ¨è¿™ä¸ªå±‚ä¸­ã€‚</p><p id="20d025ac-40aa-488f-82f5-b2ec933d11da" class="">å¦‚æœè¦åˆ é™¤åªè¯»å±‚é‡Œä¸€ä¸ªåå« foo çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ é™¤æ“ä½œå®é™…ä¸Šæ˜¯åœ¨å¯è¯»å†™å±‚åˆ›å»ºäº†ä¸€ä¸ªåå«.wh.foo çš„æ–‡ä»¶ã€‚è¿™æ ·ï¼Œå½“è¿™ä¸¤ä¸ªå±‚è¢«è”åˆæŒ‚è½½ä¹‹åï¼Œfoo æ–‡ä»¶å°±ä¼šè¢«.wh.foo æ–‡ä»¶â€œé®æŒ¡â€èµ·æ¥ï¼Œâ€œæ¶ˆå¤±â€äº†ã€‚è¿™ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯â€œro+whâ€çš„æŒ‚è½½æ–¹å¼ï¼Œå³åªè¯» +whiteout çš„å«ä¹‰</p></li></ul><ul id="40fdd44d-8463-445f-85bc-aca33458dc3c" class="bulleted-list"><li>initå±‚<p id="adc3d727-2725-4780-ab33-a1d6d20278a1" class="">å®ƒæ˜¯ä¸€ä¸ªä»¥â€œ-initâ€ç»“å°¾çš„å±‚ï¼Œå¤¹åœ¨åªè¯»å±‚å’Œè¯»å†™å±‚ä¹‹é—´ã€‚Init å±‚æ˜¯ Docker é¡¹ç›®å•ç‹¬ç”Ÿæˆçš„ä¸€ä¸ªå†…éƒ¨å±‚ï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾ /etc/hostsã€/etc/resolv.conf ç­‰ä¿¡æ¯ã€‚</p><p id="6917edb2-c86e-400a-85f4-ff7060763ca6" class="">éœ€è¦è¿™æ ·ä¸€å±‚çš„åŸå› æ˜¯ï¼Œè¿™äº›æ–‡ä»¶æœ¬æ¥å±äºåªè¯»çš„ Ubuntu é•œåƒçš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ç”¨æˆ·å¾€å¾€éœ€è¦åœ¨å¯åŠ¨å®¹å™¨æ—¶å†™å…¥ä¸€äº›æŒ‡å®šçš„å€¼æ¯”å¦‚ hostnameï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨å¯è¯»å†™å±‚å¯¹å®ƒä»¬è¿›è¡Œä¿®æ”¹ã€‚å¯æ˜¯ï¼Œè¿™äº›ä¿®æ”¹å¾€å¾€åªå¯¹å½“å‰çš„å®¹å™¨æœ‰æ•ˆï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›æ‰§è¡Œ docker commit æ—¶ï¼ŒæŠŠè¿™äº›ä¿¡æ¯è¿åŒå¯è¯»å†™å±‚ä¸€èµ·æäº¤æ‰ã€‚</p><p id="194b1e13-ba8d-4264-bff6-c11d8ac69b91" class="">æ‰€ä»¥ï¼ŒDocker åšæ³•æ˜¯ï¼Œåœ¨ä¿®æ”¹äº†è¿™äº›æ–‡ä»¶ä¹‹åï¼Œä»¥ä¸€ä¸ªå•ç‹¬çš„å±‚æŒ‚è½½äº†å‡ºæ¥ã€‚è€Œç”¨æˆ·æ‰§è¡Œ docker commit åªä¼šæäº¤å¯è¯»å†™å±‚ï¼Œæ‰€ä»¥æ˜¯ä¸åŒ…å«è¿™äº›å†…å®¹çš„ã€‚</p></li></ul><p id="d910e7a1-dcc3-44bc-9458-a1deb8e65306" class="">
</p><ol id="220cb8b6-733a-41a1-9eb2-1a25addafd76" class="numbered-list" start="1"><li>æ—¢ç„¶å®¹å™¨çš„ rootfsï¼ˆæ¯”å¦‚ï¼ŒUbuntu é•œåƒï¼‰ï¼Œæ˜¯ä»¥åªè¯»æ–¹å¼æŒ‚è½½çš„ï¼Œé‚£ä¹ˆåˆå¦‚ä½•åœ¨å®¹å™¨é‡Œä¿®æ”¹ Ubuntu é•œåƒçš„å†…å®¹å‘¢ï¼Ÿï¼ˆæç¤ºï¼šCopy-on-Writeï¼‰<p id="040f09d6-4c13-4e84-9b7c-7122347f1f8e" class="">ä¸Šé¢çš„è¯»å†™å±‚é€šå¸¸ä¹Ÿç§°ä¸ºå®¹å™¨å±‚ï¼Œä¸‹é¢çš„åªè¯»å±‚ç§°ä¸ºé•œåƒå±‚ï¼Œæ‰€æœ‰çš„å¢åˆ æŸ¥æ”¹æ“ä½œéƒ½åªä¼šä½œç”¨åœ¨å®¹å™¨å±‚ï¼Œç›¸åŒçš„æ–‡ä»¶ä¸Šå±‚ä¼šè¦†ç›–æ‰ä¸‹å±‚ã€‚çŸ¥é“è¿™ä¸€ç‚¹ï¼Œå°±ä¸éš¾ç†è§£é•œåƒæ–‡ä»¶çš„ä¿®æ”¹ï¼Œæ¯”å¦‚ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šä»ä¸Šåˆ°ä¸‹æŸ¥æ‰¾æœ‰æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰¾åˆ°ï¼Œå°±å¤åˆ¶åˆ°å®¹å™¨å±‚ä¸­ï¼Œä¿®æ”¹ï¼Œä¿®æ”¹çš„ç»“æœå°±ä¼šä½œç”¨åˆ°ä¸‹å±‚çš„æ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼ä¹Ÿè¢«ç§°ä¸ºcopy-on-write</p></li></ol><ol id="575dc778-f2fa-48f6-81a7-20354711f17e" class="numbered-list" start="2"><li>é™¤äº† AuFSï¼Œä½ çŸ¥é“ Docker é¡¹ç›®è¿˜æ”¯æŒå“ªäº› UnionFS å®ç°å—ï¼Ÿä½ èƒ½è¯´å‡ºä¸åŒå®¿ä¸»æœºç¯å¢ƒä¸‹æ¨èä½¿ç”¨å“ªç§å®ç°å—ï¼Ÿ<p id="dbcc910c-c0df-4efa-8ffa-82f1f072626c" class="">Ubuntu: aufs, overlayfs</p><p id="4f67e824-1b26-4f1d-8d4f-9e8912c8aa3e" class="">centos: overlayfs, devicemapper</p><p id="cfb26923-9878-4aac-801e-14d92cb0cd8b" class="">solaris: vfs, zfs</p><p id="190495a4-a230-4abb-a058-391bba203b74" class="">SUSE: btrfs</p></li></ol></details></li></ul><p id="70d7f485-12fa-4826-878a-9e8cb94b136f" class="">
</p></div></article></body></html>